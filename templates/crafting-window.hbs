<div class="bg3-craft-container">
    <aside class="craft-sidebar">
        <div class="recipe-header">
            <h3>Рецепты</h3>
            {{#if user.isGM}}
            <div class="player-selector">
                <div class="dropdown">
                    <button class="dropdown-toggle" id="playerDropdown" type="button" data-toggle="dropdown">
                        <span id="selectedPlayerName">
                            {{#if (eq selectedPlayerId "all")}}
                                Все игроки
                            {{else}}
                                {{#each players}}
                                    {{#if (eq ../selectedPlayerId this.id)}}
                                        {{this.name}}
                                    {{/if}}
                                {{/each}}
                                {{#unless players}}
                                    Все игроки
                                {{/unless}}
                            {{/if}}
                        </span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="playerDropdownMenu">
                        <a class="dropdown-item {{#if (eq selectedPlayerId "all")}}active{{/if}}" data-player-id="all" href="#">Все игроки</a>
                        {{#each players}}
                        <a class="dropdown-item {{#if (eq ../selectedPlayerId this.id)}}active{{/if}}" data-player-id="{{this.id}}" href="#">{{this.name}}</a>
                        {{/each}}
                    </div>
                </div>
            </div>
            {{/if}}
        </div>
        
        <!-- Окно изучения рецептов -->
        <div class="recipe-discovery">
            <div class="discovery-slot scrolls-trigger" data-tooltip="Открыть свитки для изучения рецептов">
                <i class="fas fa-book-open"></i>
                <span>Изучить рецепт</span>
            </div>
            {{#if user.isGM}}
            <div class="gm-controls">
                <button class="gm-reset-btn" data-tooltip="Очистить все пользовательские рецепты (только для ГМ)">
                    <i class="fas fa-trash"></i>
                    <span>Очистить рецепты</span>
                </button>
            </div>
            {{/if}}
        </div>
        
        <div class="recipe-list">
            <!-- Глобальные категории -->
            {{#each globalCategories}}
            <div class="recipe-group global-category" data-category="{{this.id}}">
                <div class="group-header global-header" data-group="{{this.id}}">
                    <div class="category-icon"></div>
                    <span class="category-name">{{this.name}}</span>
                    <span class="category-chevron">{{#if (lookup ../expandedGroups this.id)}}▼{{else}}▶{{/if}}</span>
                </div>
                {{#if (lookup ../expandedGroups this.id)}}
                <div class="group-content">
                    <div class="subcategories">
                        {{#each this.subcategories}}
                        <div class="subcategory-group" data-subcategory="{{this.id}}">
                            <div class="subcategory-header">
                                <span class="subcategory-icon"></span>
                                <span>{{this.name}}</span>
                                <span class="subcategory-recipe-count">{{this.recipes.length}}</span>
                                <span class="subcategory-chevron">{{#if (lookup ../../expandedSubcategories this.id)}}▼{{else}}▶{{/if}}</span>
                            </div>
                            {{#if (lookup ../../expandedSubcategories this.id)}}
                            <div class="subcategory-content">
                                {{#each this.recipes}}
                                <div class="category-btn recipe-item {{#if (eq ../../../selectedRecipe.name this.name)}}active{{/if}}" 
                                     data-index="{{this.originalIndex}}">
                                    <span style="flex: 1;">{{this.name}}</span>
                                    {{#if this.isGM}}
                                        {{#if this.canToggle}}
                                            <i class="fas fa-eye knowledge-toggle {{#if this.isKnown}}known{{else}}unknown{{/if}}" 
                                               data-id="{{this.id}}" 
                                               title="{{#if this.isKnown}}Игрок знает рецепт{{else}}Игрок НЕ знает рецепт{{/if}}">
                                            </i>
                                        {{/if}}
                                        {{#if this.isCustom}}
                                            <i class="fas fa-times delete-recipe-btn" 
                                               data-index="{{this.originalIndex}}"
                                               title="Удалить этот рецепт">
                                            </i>
                                        {{/if}}
                                    {{/if}}
                                </div>
                                {{/each}}
                            </div>
                            {{/if}}
                        </div>
                        {{/each}}
                    </div>
                </div>
                {{/if}}
            </div>
            {{/each}}
        </div>
    </aside>

    <main class="craft-workspace">
        <h3 class="section-title">
            {{#if selectedRecipe}}{{selectedRecipe.name}}{{else}}Выберите рецепт{{/if}}
        </h3>

        <!-- Индикатор наличия наборов -->
        {{#if craftingKits.hasAnyKit}}
            {{#each craftingKits.kits}}
                {{#if this.hasKit}}
                    <div class="kit-status valid">
                        <i class="fas fa-check-circle"></i>
                        <span>Есть набор *{{this.name}}*</span>
                    </div>
                {{/if}}
            {{/each}}
        {{else}}
            <div class="kit-status invalid">
                <i class="fas fa-times-circle"></i>
                <span>Нет ни одного набора!</span>
            </div>
        {{/if}}

        <div class="craft-stage">
            <div class="components-area">
                <div class="slot-container">
                    <div class="item-slot {{#if slots.slot1.isValid}}valid{{else if slots.slot1}}invalid{{/if}}">
                        {{#if slots.slot1}}
                            <img src="{{slots.slot1.img}}" data-tooltip="{{slots.slot1.name}}" class="slot-image">
                            <span class="slot-qty-text {{#if slots.slot1.isValid}}ok{{else}}bad{{/if}}">
                                {{slots.slot1.currentQty}}/{{slots.slot1.requiredQty}}
                            </span>
                        {{/if}}
                    </div>
                    <span class="slot-label">Основа</span>
                </div>
                
                <div class="slot-container" style="opacity: {{#if slots.slot2}}1{{else}}0.3{{/if}};">
                    <div class="item-slot {{#if slots.slot2.isValid}}valid{{else if slots.slot2}}invalid{{/if}}">
                         {{#if slots.slot2}}
                            <img src="{{slots.slot2.img}}" data-tooltip="{{slots.slot2.name}}" class="slot-image">
                            <span class="slot-qty-text {{#if slots.slot2.isValid}}ok{{else}}bad{{/if}}">
                                {{slots.slot2.currentQty}}/{{slots.slot2.requiredQty}}
                            </span>
                        {{/if}}
                    </div>
                    <span class="slot-label">Доп. компонент</span>
                </div>

                <div class="slot-container">
                    <div class="item-slot {{#if slots.slot3.isValid}}valid{{else if slots.slot3}}invalid{{/if}}">
                        {{#if slots.slot3}}
                            <img src="{{slots.slot3.img}}" data-tooltip="{{slots.slot3.name}}" class="slot-image">
                            <span class="slot-qty-text {{#if slots.slot3.isValid}}ok{{else}}bad{{/if}}">
                                {{slots.slot3.currentQty}}/{{slots.slot3.requiredQty}}
                            </span>
                        {{/if}}
                    </div>
                    <span class="slot-label">Катализатор</span>
                </div>
            </div>

            <div class="result-area">
                {{#if resultItem}}
                    <!-- Добавляем класс редкости динамически -->
                    <div class="result-slot rarity-{{resultItem.rarity}}">
                        <img src="{{resultItem.img}}" data-tooltip="{{resultItem.name}}" class="slot-image">
                    </div>
                {{else}}
                    <div class="result-slot" style="opacity: 0.3;">
                        <i class="fas fa-question"></i>
                    </div>
                {{/if}}
            </div>
        </div>

        <div class="controls-area">
                <button class="bg3-btn main-action {{#if canCraft}}craft-enabled{{else}}craft-disabled{{/if}}">
                    СОЗДАТЬ
                </button>
            </div>
    </main>
</div>
